generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  HR_MANAGER
  DEPARTMENT_HEAD
  BRANCH_MANAGER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  first_name    String
  last_name     String
  middle_name   String?
  phone_number  String?
  telegram_id   String?   @unique
  role          UserRole  @default(EMPLOYEE)
  status        UserStatus @default(ACTIVE)
  avatar        String?
  department_id String?
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  personal_data_consent Boolean @default(false)
  consent_date          DateTime?

  employee      Employee?
  created_tasks  Task[]    @relation("CreatedTasks")
  assigned_tasks Task[]    @relation("AssignedTasks")
  comments       TaskComment[]
  attachments    TaskAttachment[]
  wallet         Wallet?
  sent_transactions     Transaction[] @relation("SentTransactions")
  received_transactions Transaction[] @relation("ReceivedTransactions")
  notifications  Notification[]
  audit_logs     AuditLog[]
  purchases      Purchase[]
  statuses       UserGamificationStatus[]
  achievements   UserAchievement[]

  // OFS Relations
  employee_roles          EmployeeRole[]
  assigned_roles          EmployeeRole[]        @relation("RoleAssigner")
  structure_changes       OrgStructureHistory[]
  subordinate_relations   ReportingRelationship[] @relation("SubordinateRelation")
  supervisor_relations    ReportingRelationship[] @relation("SupervisorRelation")
  triangle_assignments    TriangleAssignment[]
  raci_entries            RaciMatrix[]
  submitted_ideas         IdeaChannel[]
  hybrid_interactions     HybridTeamInteraction[]

  @@map("users")
}

enum EmployeeStatus {
  UNIVERSE
  STAR
  FLINT_CARBON
  TOPCHIK
  PHOTON
}

enum EmployeeRank {
  COLLECTOR
  INVESTOR
  MAGNATE
}

model Department {
  id          String       @id @default(uuid())
  name        String       @unique
  code        String       @unique
  description String?
  head_id     String?
  parent_id   String?
  
  // OFS Module fields
  functions           String[]
  kpis                Json?
  annual_goals        String?
  budget_annual       Decimal?     @db.Decimal(15, 2)
  is_active           Boolean      @default(true)
  level               Int          @default(0)
  path                String?      // ltree type
  department_type     String?      // 'operational', 'support', 'management'
  faculty_link        String?      // Link to Corporate University faculty
  hierarchy_level     Int?         // 1-7: Constitution hierarchy
  
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  employees   Employee[]
  tasks       Task[]
  parent      Department?  @relation("DepartmentHierarchy", fields: [parent_id], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  role_matrices RoleCompetencyMatrix[]

  @@map("departments")
}

model Employee {
  id               String         @id @default(uuid())
  user_id          String         @unique
  department_id    String?
  position         String?
  bio              String?
  status           EmployeeStatus @default(PHOTON)
  rank             EmployeeRank   @default(COLLECTOR)
  salary           Decimal?       @db.Decimal(10, 2)
  employee_number  String?        @unique
  hired_at         DateTime       @default(now())
  hire_date        DateTime?
  termination_date DateTime?
  emotional_tone   Int?           @default(0)
  mc_balance       Decimal?       @default(0) @db.Decimal(10, 2)
  gmc_balance      Decimal?       @default(0) @db.Decimal(10, 2)
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  user             User           @relation(fields: [user_id], references: [id])
  department       Department?    @relation(fields: [department_id], references: [id])

  @@map("employees")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id            String       @id @default(uuid())
  title         String
  description   String
  status        TaskStatus   @default(TODO)
  priority      TaskPriority @default(MEDIUM)
  creator_id    String
  assignee_id   String?
  department_id String?
  due_date      DateTime?
  completed_at  DateTime?
  tags          String[]
  mc_reward     Decimal?     @db.Decimal(10, 2)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  creator     User             @relation("CreatedTasks", fields: [creator_id], references: [id])
  assignee    User?            @relation("AssignedTasks", fields: [assignee_id], references: [id])
  department  Department?      @relation(fields: [department_id], references: [id])
  comments    TaskComment[]
  attachments TaskAttachment[]

  @@map("tasks")
}

model TaskComment {
  id         String   @id @default(uuid())
  task_id    String
  user_id    String
  text       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  task Task @relation(fields: [task_id], references: [id])
  user User @relation(fields: [user_id], references: [id])

  @@map("task_comments")
}

model TaskAttachment {
  id         String   @id @default(uuid())
  task_id    String
  user_id    String
  file_url   String
  file_name  String
  file_type  String
  created_at DateTime @default(now())

  task Task @relation(fields: [task_id], references: [id])
  user User @relation(fields: [user_id], references: [id])

  @@map("task_attachments")
}

enum Currency {
  MC
  GMC
  RUB
}

enum TransactionType {
  EARN
  SPEND
  TRANSFER
  REWARD
  PENALTY
  AUCTION_BID
  AUCTION_WIN
  STORE_PURCHASE
  SAFE_ACTIVATION
}

model Wallet {
  id                String    @id @default(uuid())
  user_id           String    @unique
  mc_balance        Decimal   @default(0) @db.Decimal(10, 2)
  gmc_balance       Decimal   @default(0) @db.Decimal(10, 2)
  mc_frozen         Decimal   @default(0) @db.Decimal(10, 2)
  safe_activated_at DateTime?
  safe_expires_at   DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@map("wallets")
}

model Transaction {
  id           String          @id @default(uuid())
  type         TransactionType
  currency     Currency
  amount       Decimal         @db.Decimal(10, 2)
  sender_id    String?
  recipient_id String?
  description  String?
  metadata     Json?
  created_at   DateTime        @default(now())

  sender    User? @relation("SentTransactions", fields: [sender_id], references: [id])
  recipient User? @relation("ReceivedTransactions", fields: [recipient_id], references: [id])

  @@map("transactions")
}

model Notification {
  id         String    @id @default(uuid())
  user_id    String
  type       String
  title      String
  message    String
  read       Boolean   @default(false)
  read_at    DateTime?
  metadata   Json?
  created_at DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("notifications")
}

model AuditLog {
  id          String   @id @default(uuid())
  user_id     String?
  action      String
  entity_type String?
  entity_id   String?
  details     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String
  price       Decimal  @db.Decimal(10, 2)
  stock       Int      @default(0)
  image_url   String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  purchases   Purchase[]

  @@map("products")
}

model Purchase {
  id         String   @id @default(uuid())
  user_id    String
  product_id String
  price_paid Decimal  @db.Decimal(10, 2)
  status     String   @default("COMPLETED")
  created_at DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@map("purchases")
}

model GamificationLevel {
  id           String       @id @default(uuid())
  name         String       @unique
  level        Int          @unique
  requirements Json?
  users        UserGamificationStatus[]
  created_at   DateTime     @default(now())
  updated_at   DateTime     @updatedAt

  @@map("gamification_levels")
}

model UserGamificationStatus {
  id          String   @id @default(uuid())
  user_id     String
  status_id   String
  achieved_at DateTime @default(now())

  user   User   @relation(fields: [user_id], references: [id])
  status GamificationLevel @relation(fields: [status_id], references: [id])

  @@unique([user_id, status_id])
  @@index([user_id])
  @@index([achieved_at])
  @@map("user_gamification_statuses")
}

model Achievement {
  id          String            @id @default(uuid())
  name        String
  description String?
  icon_url    String?
  users       UserAchievement[]
  created_at  DateTime          @default(now())

  @@map("achievements")
}

model UserAchievement {
  id             String   @id @default(uuid())
  user_id        String
  achievement_id String
  earned_at      DateTime @default(now())

  user        User        @relation(fields: [user_id], references: [id])
  achievement Achievement @relation(fields: [achievement_id], references: [id])

  @@unique([user_id, achievement_id])
  @@index([user_id])
  @@map("user_achievements")
}

enum LeaderboardMetric {
  MC_BALANCE
  GMC_BALANCE
  COMPLETED_TASKS
  STATUS_LEVEL
}

enum LeaderboardPeriod {
  WEEK
  MONTH
  ALL_TIME
}

model Leaderboard {
  id         String             @id @default(uuid())
  metric     LeaderboardMetric
  period     LeaderboardPeriod
  top_users  Json               // Array of top 100 users with their stats
  updated_at DateTime           @updatedAt
  created_at DateTime           @default(now())

  @@unique([metric, period])
  @@map("leaderboards")
}

enum QuestStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

model Quest {
  id              String   @id @default(uuid())
  title           String
  description     String?
  icon_url        String?
  requirements    Json?    // Conditions to complete the quest
  reward_mc       Int      @default(0)
  reward_gmc      Int      @default(0)
  is_active       Boolean  @default(true)
  duration_days   Int?     // Quest duration in days
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  progress        QuestProgress[]

  @@map("quests")
}

model QuestProgress {
  id           String      @id @default(uuid())
  user_id      String
  quest_id     String
  progress     Json?       // Detailed progress tracking
  status       QuestStatus @default(NOT_STARTED)
  started_at   DateTime?
  completed_at DateTime?
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt

  quest        Quest       @relation(fields: [quest_id], references: [id], onDelete: Cascade)

  @@unique([user_id, quest_id])
  @@index([user_id])
  @@index([status])
  @@map("quest_progress")
}

// OFS Module Models

model RoleCompetencyMatrix {
  id                        String   @id @default(uuid())
  role_name                 String
  department_id             String?
  required_competencies     Json
  responsibilities          String[]
  permissions               Json?
  salary_min                Decimal? @db.Decimal(15, 2)
  salary_max                Decimal? @db.Decimal(15, 2)
  
  // MDR Fields
  purpose                   String?
  expected_results          String[]
  required_knowledge        String[]
  required_skills           String[]
  interactions              Json?
  corporate_university_courses String[]
  
  // Golden Standard Fields
  golden_standard_processes String[]
  efficiency_metrics        Json?
  lean_principles           String[]
  
  // Documents
  documents                 Json?    // Array of { name: string, url: string, type: string }
  
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt

  department                Department? @relation(fields: [department_id], references: [id], onDelete: Cascade)
  employee_roles            EmployeeRole[]
  raci_matrix_entries       RaciMatrix[]

  @@unique([role_name, department_id])
  @@map("role_competency_matrix")
}

model EmployeeRole {
  id             String    @id @default(uuid())
  employee_id    String
  role_matrix_id String?
  assigned_at    DateTime  @default(now())
  effective_from DateTime  @db.Date
  effective_to   DateTime? @db.Date
  assigned_by    String?
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())

  user           User      @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  role           RoleCompetencyMatrix? @relation(fields: [role_matrix_id], references: [id], onDelete: Cascade)
  assigner       User?     @relation("RoleAssigner", fields: [assigned_by], references: [id])

  @@map("employee_roles")
}

model OrgStructureHistory {
  id          String   @id @default(uuid())
  entity_type String
  entity_id   String
  action      String
  changed_by  String?
  old_data    Json?
  new_data    Json?
  reason      String?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())

  changer     User?    @relation(fields: [changed_by], references: [id])

  @@map("org_structure_history")
}

model ReportingRelationship {
  id              String    @id @default(uuid())
  subordinate_id  String
  supervisor_id   String
  relationship_type String  @default("direct") // direct, functional, dotted_line
  effective_from  DateTime  @db.Date
  effective_to    DateTime? @db.Date
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())

  subordinate     User      @relation("SubordinateRelation", fields: [subordinate_id], references: [id], onDelete: Cascade)
  supervisor      User      @relation("SupervisorRelation", fields: [supervisor_id], references: [id], onDelete: Cascade)

  @@map("reporting_relationships")
}

model OrgHierarchyLevel {
  id                String   @id @default(uuid())
  level_number      Int      @unique
  level_name        String
  level_name_ru     String
  description       String?
  can_have_children Boolean  @default(true)
  created_at        DateTime @default(now())

  @@map("org_hierarchy_levels")
}

model PyramidRole {
  id          String   @id @default(uuid())
  role_type   String   // management, photographers, production, sales
  role_name   String
  description String?
  kpi_metrics Json?
  interdependencies Json?
  created_at  DateTime @default(now())

  @@unique([role_type, role_name])
  @@map("pyramid_roles")
}

model TriangleAssignment {
  id            String   @id @default(uuid())
  employee_id   String
  triangle_role String   // photographer, designer, seller
  is_primary    Boolean  @default(true)
  flow_metrics  Json?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user          User     @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("triangle_assignments")
}

model RaciMatrix {
  id           String   @id @default(uuid())
  project_name String
  task_name    String
  employee_id  String?
  role_id      String?
  raci_role    String   // R, A, C, I
  description  String?
  created_at   DateTime @default(now())

  user         User?    @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  role         RoleCompetencyMatrix? @relation(fields: [role_id], references: [id])

  @@map("raci_matrix")
}

model IdeaChannel {
  id                  String   @id @default(uuid())
  channel_type        String   // strategic, tactical, mentoring
  title               String
  description         String?
  submitted_by        String?
  target_level        Int?
  status              String   @default("submitted")
  priority            String?
  implementation_plan String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  submitter           User?    @relation(fields: [submitted_by], references: [id])

  @@map("idea_channels")
}

model HybridTeamInteraction {
  id                String   @id @default(uuid())
  human_employee_id String?
  ai_agent_name     String
  interaction_type  String?
  privacy_consent   Boolean  @default(false)
  ai_mode_enabled   Boolean  @default(true)
  interaction_data  Json?
  created_at        DateTime @default(now())

  human_employee    User?    @relation(fields: [human_employee_id], references: [id], onDelete: Cascade)

  @@map("hybrid_team_interactions")
}

// Corporate University Module

enum MaterialType {
  VIDEO
  TEXT
  PDF
  QUIZ
  SIMULATION
}

enum MaterialStatus {
  DRAFT
  REVIEW
  PUBLISHED
}

enum CourseGrade {
  INTERN         // стажёр
  SPECIALIST     // специалист
  PROFESSIONAL   // профессионал
  EXPERT         // эксперт
  MASTER         // мастер
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum ModuleStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum TrainerSpecialty {
  PHOTOGRAPHER
  SALES
  DESIGNER
}

enum TrainerStatus {
  CANDIDATE       // кандидат
  TRAINER         // обучающий
  ACCREDITED      // аккредитованный
  SENIOR          // старший
  METHODOLOGIST   // методист
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Academy {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  icon_url    String?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  skills        Skill[]
  materials     Material[]
  courses       Course[]
  certifications Certification[]

  @@map("academies")
}

model Skill {
  id             String    @id @default(uuid())
  academy_id     String?
  name           String
  category       String?   // hard, soft, technical
  level_required String?   // A0, A1, B1, B2, C1, C2
  kpi_impact     String?   // какой KPI улучшает
  description    String?
  created_at     DateTime  @default(now())

  academy        Academy?  @relation(fields: [academy_id], references: [id], onDelete: Cascade)
  user_skills    UserSkill[]

  @@map("skills")
}

model Material {
  id               String         @id @default(uuid())
  type             MaterialType
  title            String
  content_url      String?
  content_text     String?
  duration_minutes Int?
  
  // Метаданные
  tags             Json?
  level            String?        // A0-C2
  academy_id       String?
  
  version          Int            @default(1)
  status           MaterialStatus @default(DRAFT)
  
  created_by       String?
  reviewed_by      String?
  
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  academy          Academy?       @relation(fields: [academy_id], references: [id])
  course_modules   CourseModule[]

  @@map("materials")
}

model Course {
  id             String      @id @default(uuid())
  academy_id     String?
  title          String
  description    String?
  
  required_grade CourseGrade?
  reward_mc      Int         @default(0)
  reward_gmc     Int         @default(0)
  
  is_mandatory   Boolean     @default(false)
  is_active      Boolean     @default(true)
  
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  academy        Academy?    @relation(fields: [academy_id], references: [id])
  modules        CourseModule[]
  enrollments    Enrollment[]
  certifications Certification[]

  @@map("courses")
}

model CourseModule {
  id          String   @id @default(uuid())
  course_id   String
  material_id String?
  
  module_order Int
  is_required Boolean  @default(true)
  
  created_at  DateTime @default(now())

  course      Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  material    Material? @relation(fields: [material_id], references: [id])
  progress    ModuleProgress[]

  @@map("course_modules")
}

model UserSkill {
  id          String    @id @default(uuid())
  user_id     String
  skill_id    String
  
  level       Int       @default(0) // 0-100
  verified_at DateTime?
  verified_by String?
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  skill       Skill     @relation(fields: [skill_id], references: [id])

  @@unique([user_id, skill_id])
  @@map("user_skills")
}

model UserGrade {
  id                      String      @id @default(uuid())
  user_id                 String      @unique
  
  current_grade           CourseGrade @default(INTERN)
  motivation_coefficient  Decimal     @default(0.8) @db.Decimal(3, 2)
  
  // История грейдов
  grade_history           Json        @default("[]")
  
  created_at              DateTime    @default(now())
  updated_at              DateTime    @updatedAt

  @@map("user_grades")
}

model Enrollment {
  id          String           @id @default(uuid())
  user_id     String
  course_id   String
  
  progress    Int              @default(0) // %
  status      EnrollmentStatus @default(ACTIVE)
  
  enrolled_at DateTime         @default(now())
  completed_at DateTime?
  
  assigned_by String?

  course      Course           @relation(fields: [course_id], references: [id])
  module_progress ModuleProgress[]

  @@unique([user_id, course_id])
  @@map("enrollments")
}

model ModuleProgress {
  id            String       @id @default(uuid())
  enrollment_id String
  module_id     String
  
  status        ModuleStatus @default(NOT_STARTED)
  score         Int?
  
  started_at    DateTime?
  completed_at  DateTime?

  enrollment    Enrollment   @relation(fields: [enrollment_id], references: [id], onDelete: Cascade)
  module        CourseModule @relation(fields: [module_id], references: [id])

  @@map("module_progress")
}

model Certification {
  id              String      @id @default(uuid())
  user_id         String
  course_id       String?
  academy_id      String?
  
  level           CourseGrade?
  score           Int?
  
  issued_at       DateTime    @default(now())
  expires_at      DateTime?
  
  certificate_url String?

  course          Course?     @relation(fields: [course_id], references: [id])
  academy         Academy?    @relation(fields: [academy_id], references: [id])

  @@map("certifications")
}

model LearningPath {
  id              String   @id @default(uuid())
  user_id         String   @unique
  
  title           String?
  courses_planned Json?    // массив course_id
  skills_target   Json?    // целевые навыки
  
  ai_generated    Boolean  @default(false)
  ai_rules        Json?    // правила генерации
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("learning_paths")
}

// === TRAINER INSTITUTE ===

model Trainer {
  id                 String           @id @default(uuid())
  user_id            String           @unique
  
  specialty          TrainerSpecialty
  status             TrainerStatus    @default(CANDIDATE)
  
  accreditation_date DateTime?
  rating             Decimal?         @db.Decimal(3, 2)
  
  // Статистика
  trainees_total     Int              @default(0)
  trainees_successful Int             @default(0)
  avg_nps            Decimal?         @db.Decimal(3, 2)
  
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt

  assignments        TrainerAssignment[]

  @@map("trainers")
}

model TrainerAssignment {
  id          String           @id @default(uuid())
  trainer_id  String
  trainee_id  String
  
  start_date  DateTime         @db.Date
  end_date    DateTime?        @db.Date
  
  status      AssignmentStatus @default(ACTIVE)
  plan        Json?            // индивидуальный план на 4 смены
  
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  trainer     Trainer          @relation(fields: [trainer_id], references: [id])
  results     TrainingResult[]

  @@map("trainer_assignments")
}

model TrainingResult {
  id                   String   @id @default(uuid())
  assignment_id        String
  
  kpi_improvement      Int?     // % улучшения KPI
  nps_score            Int?     // оценка стажёра
  retention_days       Int?     // сколько дней удержан
  
  hot_leads_percentage Int?     // % горячих лидов
  quality_score        Int?     // оценка качества работы
  
  notes                String?
  
  created_at           DateTime @default(now())

  assignment           TrainerAssignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)

  @@map("training_results")
}
