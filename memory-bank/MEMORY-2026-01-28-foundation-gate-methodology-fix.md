# MEMORY: Foundation Gate Methodology Fix & Registration Flow Evolution
**Дата:** 2026-01-28

## I. Исправление Foundation Gate (v2.2-canon)
### Проблема
Пользователи были заблокированы из-за «Методологической ошибки» (isMethodologyViolated). Скрипт сидирования (`seed-foundation-gate.ts`) искал видео в `backend/content`, а они находились в корне проекта.

### Решение
- **Fix:** Скорректирован `VIDEO_PATH` в скрипте сидинга.
- **Action:** Перевыполнен `npm run seed:foundation`. Кнопка «Принять» теперь активна, видео воспроизводятся.
- **Bypass:** Для администратора (`admin@photomatrix.ru`) выполнен принудительный разлок через скрипт `fix-admin-foundation.ts` (статус `ACCEPTED`).

## II. Эволюция процесса регистрации (Telegram MVP v2)
Это не просто фикс багов, а качественное изменение UX регистрации через Telegram-бот.

### 1. Переход к Реестровой Модели (Registry-Driven)
- **Было:** Должность и локация вводились пользователем вручную текстом. Это приводило к ошибкам, опечаткам и невозможности аналитики.
- **Стало:** Данные выбираются из официальных таблиц `positions` и `locations`.
- **Реализация:** Созданы справочники должностей и локаций, которые теперь являются обязательным источником для модуля 33 (Personnel HR Records).

### 2. Структурированное взаимодействие (Structured Interactivity)
- **Новый Паттерн:** Внедрено использование **Inline Keyboard Buttons** для этапов выбора должности и локации.
- **Тех. детали:** 
  - Методы `promptPositionStep` и `promptLocationStep` генерируют кнопки на основе данных из БД.
  - Обработка через колбэки `position_` и `location_` в `telegram.service.ts`.
- **UX:** Время регистрации сокращено, исключен ввод некорректных данных.

### 3. Техническая стабилизация SQL
- **Проблема:** Массовые 500 ошибки из-за `text = uuid` несоответствия типов.
- **Решение:** Проведена ревизия `employee-registration.service.ts`. Удалены все ручные касты `::uuid`. Система переведена на консистентную работу с ID как с `String/Text`.

## Итог
Система Допуска (Foundation) и Система Регистрации (Registration) приведены в соответствие с Каноном: данные структурированы, UX автоматизирован, критические блокировки сняты.

### 3. Диагностика
- **Файл:** `backend/src/diagnose_foundation.ts`
- **Функция:** Проверка целостности данных гейта, наличия материалов и статуса конкретного пользователя. Использовался для верификации фикса.

## Результат
- Контур Допуска (v2.2-canon) полностью функционален.
- Видео подгружаются корректно.
- Администратор разблокирован и имеет доступ к Dashboard.

## Рекомендации
При деплое на новые окружения:
1. Убедиться, что папка `content/videos/foundation` существует в корне проекта.
2. Выполнить `npm run seed:foundation` в папке `backend`.
3. Для админ-аккаунтов использовать `fix-admin-foundation.ts` при необходимости ручного байпаса.
