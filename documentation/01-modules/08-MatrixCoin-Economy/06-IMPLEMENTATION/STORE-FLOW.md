
## MatrixCoin — Store Purchase Flow (Backend Specification)

Версия: v1.0  
Статус: WORKING SPEC  
Назначение: формальное описание backend-логики покупки товара в магазине  
Аудитория: Backend, QA, DevOps

---

## 1. НАЗНАЧЕНИЕ FLOW

Данный flow описывает **единственный допустимый способ списания MC** через магазин:
- с проверкой ограничений
- с защитой от повторов
- с гарантией целостности данных (ACID)

Любое отклонение от этого flow считается **ошибкой реализации**.

---

## 2. ТОЧКА ВХОДА

POST /api/store/purchase

bash
Копировать код

### Request payload
```json
{
  "item_id": "string",
  "idempotency_key": "uuid"
}
item_id — идентификатор товара

idempotency_key — уникальный ключ запроса (обязателен)

3. ПРЕДУСЛОВИЯ (PRE-CHECKS)
3.1 Аутентификация
пользователь обязан быть аутентифицирован

user_id извлекается из auth context

передача user_id из frontend запрещена

3.2 Проверка idempotency
система проверяет, существует ли транзакция с данным idempotency_key

если существует:

возвращается успешный ответ

никаких изменений данных не производится

3.3 Проверка существования товара
StoreItem с item_id должен существовать

is_active = true

иначе → ошибка ITEM_NOT_AVAILABLE

4. ПРОВЕРКА ОГРАНИЧЕНИЙ (CONSTRAINTS)
Проверки выполняются ДО начала списаний.

4.1 Проверка баланса
wallet.mc_balance >= item.price_mc

иначе → ошибка INSUFFICIENT_FUNDS

4.2 Проверка бизнес-ограничений
Возможные ограничения:

лимит покупок (per day / per month / lifetime)

cooldown между покупками

кастомные условия

Если любое ограничение нарушено:

операция прерывается

ошибка ITEM_CONSTRAINT_VIOLATION

5. ТРАНЗАКЦИОННЫЙ БЛОК (CRITICAL SECTION)
Все операции ниже выполняются в одной транзакции БД.

5.1 Начало DB transaction
используется транзакция БД (ACID)

любые изменения вне транзакции запрещены

5.2 Списание средств
wallet.mc_balance -= item.price_mc

прямое обновление баланса вне этого flow запрещено

5.3 Создание transaction record
Создаётся запись типа spend:

json
Копировать код
{
  "user_id": "...",
  "amount": -500,
  "currency": "MC",
  "source": "store",
  "item_id": "...",
  "idempotency_key": "...",
  "status": "completed"
}
5.4 Фиксация результата покупки
фиксируется факт покупки товара

обновляются счётчики лимитов

при необходимости создаётся StorePurchase record

5.5 Commit
транзакция коммитится

изменения становятся видимыми

6. ROLLBACK ЛОГИКА
Если на любом этапе после начала транзакции возникает ошибка:

выполняется rollback транзакции

баланс возвращается в исходное состояние

transaction record не создаётся

idempotency_key не сохраняется

7. RESPONSE
7.1 Успешный ответ
json
Копировать код
{
  "status": "success",
  "transaction_id": "uuid",
  "new_balance": {
    "mc": 740,
    "gmc": 2
  }
}
7.2 Ошибки
Код	HTTP	Описание
UNAUTHORIZED	401	Пользователь не авторизован
ITEM_NOT_AVAILABLE	404	Товар не существует или выключен
INSUFFICIENT_FUNDS	409	Недостаточно MC
ITEM_CONSTRAINT_VIOLATION	409	Нарушены условия покупки
DUPLICATE_REQUEST	200	Повторный idempotent-запрос
INTERNAL_ERROR	500	Неизвестная ошибка

8. ИНВАРИАНТЫ (ОБЯЗАТЕЛЬНО)
Баланс НИКОГДА не уходит в минус

Любая покупка = transaction record

Нет transaction → нет списания

Повтор запроса не меняет состояние

Никаких partial-updates

9. ЛОГИРОВАНИЕ И AUDIT
Логируется:

user_id

item_id

idempotency_key

результат операции

причина отказа (если есть)

10. ACCEPTANCE CRITERIA
Flow считается реализованным, если:

покупка выполняется атомарно

повтор запроса безопасен

rollback работает

баланс и транзакции всегда консистентны

QA может воспроизвести все ошибки

11. OUT OF SCOPE
GMC-покупки

Аукционы

Admin-покупки

Возвраты средств

yaml
Копировать код

---

## СТАТУС
**STORE-FLOW.md — ГОТОВ**