# 05-edge-cases.md
## Edge Cases & Failure Scenarios — Domain Rulebook (MC / GMC)

---

## 0. Назначение документа

Документ описывает **нестандартные, аварийные и пограничные ситуации**
в работе MatrixCoin Economy.

Цель:
- убрать импровизацию в критических моментах;
- зафиксировать, что делать при сбоях;
- исключить ручные «костыли».

Документ:
- **не является CANON**;
- предназначен для эксплуатации;
- может расширяться по мере накопления опыта.

---

## 1. Общий принцип обработки edge-cases

Во всех нестандартных ситуациях действует порядок:

1. **Остановить автоматические действия**
2. **Ничего не пересчитывать**
3. **Посмотреть audit**
4. **Принять решение человеком**
5. **Зафиксировать решение отдельным событием**

Если шаги нарушены — риск слома домена.

---

## 2. Ошибки во время аукциона

### 2.1. Сбой при приёме ставки

Симптом:
- пользователь отправил ставку;
- система вернула ошибку.

Действия:
- ставка не считается принятой;
- MC не резервируются;
- фиксируется событие ошибки.

Запрещено:
- вручную «добавлять» ставку;
- считать ошибку принятой ставкой.

---

### 2.2. Две ставки одновременно (race condition)

Симптом:
- два события пришли с минимальной разницей во времени.

Действия:
- используется порядок событий audit;
- первая валидная ставка считается принятой;
- вторая валидируется отдельно.

Запрещено:
- менять порядок задним числом.

---

### 2.3. Аукцион закрыт, но пришла ставка

Действия:
- ставка отклоняется;
- MC не резервируются;
- фиксируется ошибка участия.

---

## 3. Ошибки при списании MC

### 3.1. Аукцион завершён, списание не произошло

Симптом:
- победитель определён;
- MC не перешли в Consumed.

Действия:
- автоматического перерасчёта нет;
- система переходит в ручной режим;
- проверяется audit.

Решение:
- принимается человеком;
- фиксируется событием корректировки.

---

### 3.2. MC списались, но GMC не признан

Симптом:
- `MCConsumed` есть;
- `GMCRecognized` отсутствует.

Действия:
- GMC **не признаётся автоматически**;
- проводится ручной разбор;
- либо признаётся GMC,
- либо фиксируется отказ.

---

## 4. Ошибки GMC

### 4.1. Конфликт условий признания

Симптом:
- условия выполнены частично;
- данные противоречивы.

Действия:
- GMC не признаётся;
- система остаётся в текущем состоянии;
- решение принимает человек.

---

### 4.2. Ошибка при активации GMC

Симптом:
- GMC признан;
- условия активации не сработали.

Действия:
- GMC остаётся в Locked;
- повторная проверка без пересчёта;
- фиксация результата.

---

## 5. Пользовательские edge-cases

### 5.1. Пользователь ушёл из системы

Если пользователь:
- имеет MC → остаются в истории;
- имеет GMC → остаются в архиве;
- участвовал в аукционе → история не меняется.

Запрещено:
- удалять события;
- «обнулять» историю.

---

### 5.2. Пользователь заблокирован во время аукциона

Действия:
- текущий аукцион завершается по правилам;
- новые ставки запрещены;
- история не корректируется.

---

## 6. Системные состояния

### 6.1. Система в состоянии SAFE

- новые аукционы не открываются;
- текущие завершаются вручную;
- данные доступны только для чтения.

---

### 6.2. Система в состоянии INVALID

- все операции приостановлены;
- никаких перерасчётов;
- проводится аудит и восстановление.

---

## 7. Чего делать НЕЛЬЗЯ ни при каких условиях

Запрещено:
- «подкрутить баланс»;
- пересчитать историю;
- удалить события;
- компенсировать MC вручную;
- признавать GMC без основания.

---

## 8. Документирование решений

Любое ручное решение:
- оформляется отдельным событием;
- содержит причину;
- ссылается на audit-контекст.

Решения без фиксации считаются **архитектурной ошибкой**.

---

## 9. Типовые вопросы и ответы

**Q:** Можно ли «починить» аукцион задним числом?  
**A:** Нет.

**Q:** Можно ли вернуть MC из Consumed?  
**A:** Нет.

**Q:** Можно ли признать GMC «по договорённости»?  
**A:** Нет.

---

## 10. Краткое резюме

- Edge-cases — это ручные сценарии.
- Audit важнее удобства.
- История неизменяема.
- Человек принимает решение, но не переписывает прошлое.
