# Admission Flow Canon (User Admission System)

Этот документ является единственным источником правды (Single Source of Truth) для процесса допуска пользователя в систему MatrixGin. Любые изменения в логике регистрации, принятия Базы или прав доступа должны сначала фиксироваться здесь.

## 1. Стейт-машина Допуска (Admission FSM)

Пользователь проходит через следующие состояния:

| Статус (`admission_status`) | Описание | Доступ (Scopes) | Редирект (Web) | ТГ Команды |
| :--- | :--- | :--- | :--- | :--- |
| `PENDING_BASE` | Начало. Пользователь зашел, но не ознакомился с принципами. | `foundation:read`, `foundation:accept` | `/foundation` | Только `/start` |
| `BASE_ACCEPTED` | База принята. Разрешен переход к анкете (персональные данные). | `profile:write`, `foundation:read` | `/registration` | Только анкета |
| `PROFILE_COMPLETE` | Анкета заполнена. Ожидается проверка/верификация. | `profile:read`, `foundation:read` | Заглушка "На проверке" | Только статус |
| `ADMITTED` | Полный допуск. Сотрудник в системе. | `*` (RBAC) | Dashboard | Все команды |

## 2. Гейт Базы (The Foundation Gate)

Принятие Базы — это не формальность, а архитектурный барьер.

1. **Изоляция**: До принятия Базы (статус `PENDING_BASE`) пользователю запрещены ЛЮБЫЕ действия, кроме чтения блоков Базы и их принятия.
2. **Версионирование**: Принятие фиксирует конкретную версию (`base_version`). При обновлении "Критического" уровня Базы, система может сбросить статус всех пользователей до `PENDING_BASE`.
3. **Audit Trail**: Факт принятия логируется (время, версия, источник).

## 3. Протоколы защиты

### Telegram Bot
- **Strict Filtering**: Бот игнорирует все команды (задачи, баланс, профиль), кроме команд обслуживания текущего шага регистрации.
- **Auto-Nudge**: Любая посторонняя команда вызывает напоминание о необходимости принять Базу.
- **Logic**: Реализовано через `ensureAdmissionGuard` в `TelegramService`.

### Web API
- **JWT Scopes**: Токены пользователей в статусе `PENDING_BASE` имеют ограниченный набор разрешенных эндпоинтов (Layer 0).
- **Frontend Guard**: `FoundationGuard` выполняет принудительный редирект на основе `admissionStatus`.

## 4. Переход к Анкете (Personal Data)

Только после фиксации `BASE_ACCEPTED` в БД, пользователю открывается возможность предоставления данных:
1. Загрузки фото профиля.
2. Указания ФИО и контактов.
3. Загрузки сканов документов.

> [!IMPORTANT]
> Нарушение последовательности "База -> Данные" (Base-First) считается критическим нарушением архитектурного канона системы.
